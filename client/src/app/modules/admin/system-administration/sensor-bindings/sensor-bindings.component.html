<div class="absolute inset-0 flex min-w-0 flex-col overflow-hidden h-full">
    <mat-drawer-container class="flex-auto dark:bg-transparent" (backdropClick)="onCloseDrawer()">
        <mat-drawer class="w-full dark:bg-gray-900 sm:w-120" [mode]="drawerMode" [opened]="false" [position]="'end'" [disableClose]="true" #matDrawer>
            <ng-container *ngTemplateOutlet="drawerContent"></ng-container>
        </mat-drawer>

        <mat-drawer-content>
            <div class="flex flex-auto flex-col h-full bg-white dark:bg-gray-900 p-6" *transloco="let t">

                <!-- Header -->
                <div class="flex flex-row items-center justify-between px-6 py-8 md:px-8">
                    <!-- Title -->
                    <div class="text-3xl font-extrabold leading-none tracking-tight">
                        {{ t('sensor-binding-management') }}
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button mat-stroked-button (click)="loadData()">
                            <mat-icon [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                            <span class="ml-2 mr-1">{{ t('loading') }}</span>
                        </button>
                        <button mat-stroked-button (click)="onOpenDrawer()">
                            <mat-icon [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                            <span class="ml-2 mr-1">{{ t('add-binding') }}</span>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex h-full overflow-y-auto bg-card rounded-md">
                    @if(page.bindings && page.bindings.length > 0) {
                    <p-table
                        class="w-full"
                        [value]="page.bindings"
                        [scrollable]="true"
                        scrollHeight="flex"
                        [styleClass]="'p-datatable-lg'"
                        selectionMode="single"
                        [metaKeySelection]="true"
                        (onRowSelect)="onOpenDrawer($event)">
                        <ng-template pTemplate="header">
                            <tr>
                                <th class="pl-8 py-4">{{ t('user') }}</th>
                                <th>{{ t('model-urn') }}</th>
                                <th class="text-center">{{ t('element-db-id') }}</th>
                                <th>{{ t('element-name') }}</th>
                                <th class="text-center">{{ t('position-type') }}</th>
                                <th class="text-center">{{ t('status') }}</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-d>
                            <tr [pSelectableRow]="d" class="hover:bg-hover">
                                <td class="pl-8">{{getSensorName(d.sensor)}}</td>
                                <td class="text-xs">{{d.model_urn}}</td>
                                <td class="text-center">{{d.element_dbid}}</td>
                                <td>{{d.element_name || '-'}}</td>
                                <td class="text-center">
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                        [ngClass]="{
                                            'bg-blue-100 text-blue-800': d.position_type === 'center',
                                            'bg-green-100 text-green-800': d.position_type === 'top',
                                            'bg-yellow-100 text-yellow-800': d.position_type === 'bottom',
                                            'bg-purple-100 text-purple-800': d.position_type === 'custom'
                                        }">
                                        {{d.position_type}}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                                        [ngClass]="{
                                            'bg-green-100 text-green-800': d.is_active,
                                            'bg-gray-100 text-gray-800': !d.is_active
                                        }">
                                        {{d.is_active ? t('active') : t('inactive')}}
                                    </span>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                    }
                    @else {
                    <div class="flex flex-auto flex-col items-center justify-center text-secondary mb-10">
                        <mat-icon class="icon-size-16" [svgIcon]="'heroicons_outline:inbox'"></mat-icon>
                        <div class="mt-4 text-xl font-semibold tracking-tight">
                            {{ t('no-binding-data') }}
                        </div>
                        <div class="mt-2 text-sm text-gray-500">{{ t('click-add-binding-description') }}</div>
                    </div>
                    }
                </div>
            </div>
        </mat-drawer-content>

    </mat-drawer-container>
</div>

<ng-template #drawerContent>
    <div class="flex flex-auto h-full" *transloco="let t">
        <div class="flex flex-auto flex-col overflow-y-auto">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-3">
                <mat-icon [svgIcon]="'heroicons_outline:link'"></mat-icon>
                <span class="text-xl">
                    @if(page.record?.id) { {{ t('edit-binding') }} }
                    @else { {{ t('add-binding') }} }
                </span>

                <div class="flex">
                    <!-- Close button -->
                    <button type="button" mat-icon-button (click)="onCloseDrawer()">
                        <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                    </button>
                </div>
            </div>

            <mat-divider></mat-divider>

            <form [formGroup]="form" class="p-8" #ngForm="ngForm">

                <!-- 感測器選擇 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('user') }} *</mat-label>
                        <mat-select [formControlName]="'sensor'">
                            @for (sensor of page.sensors; track sensor.id) {
                            <mat-option [value]="sensor.id">
                                {{sensor.name}} ({{sensor.sensor_id}})
                            </mat-option>
                            }
                        </mat-select>
                        @if(form.get('sensor').hasError('required')) {
                        <mat-error>{{ t('please-select-sensor') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <!-- 模型 URN -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('model-urn') }} *</mat-label>
                        <input matInput [formControlName]="'model_urn'" [placeholder]="t('enter-model-urn')">
                        @if(form.get('model_urn').hasError('required')) {
                        <mat-error>{{ t('please-enter-model-urn') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <!-- 元件 DB ID -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('element-db-id') }} *</mat-label>
                        <input matInput type="number" [formControlName]="'element_dbid'" [placeholder]="t('enter-element-db-id')">
                        @if(form.get('element_dbid').hasError('required')) {
                        <mat-error>{{ t('please-enter-element-db-id') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <!-- 元件名稱 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('element-name') }}</mat-label>
                        <input matInput [formControlName]="'element_name'" [placeholder]="t('enter-element-name-optional')">
                    </mat-form-field>
                </div>

                <!-- 元件外部 ID -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('element-external-id') }}</mat-label>
                        <input matInput [formControlName]="'element_external_id'" [placeholder]="t('enter-element-external-id-optional')">
                    </mat-form-field>
                </div>

                <!-- 位置類型 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('position-type') }}</mat-label>
                        <mat-select [formControlName]="'position_type'">
                            @for (option of positionTypeOptions; track option.value) {
                            <mat-option [value]="option.value">{{ t(option.value) }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- 位置偏移 -->
                <div class="mt-4">
                    <label class="text-sm font-medium">{{ t('position-offset-xyz') }}</label>
                    <div class="flex gap-2 mt-2" [formGroupName]="'position_offset'">
                        <mat-form-field class="flex-1 gts-mat-dense">
                            <mat-label>X</mat-label>
                            <input matInput type="number" [formControlName]="'x'">
                        </mat-form-field>
                        <mat-form-field class="flex-1 gts-mat-dense">
                            <mat-label>Y</mat-label>
                            <input matInput type="number" [formControlName]="'y'">
                        </mat-form-field>
                        <mat-form-field class="flex-1 gts-mat-dense">
                            <mat-label>Z</mat-label>
                            <input matInput type="number" [formControlName]="'z'">
                        </mat-form-field>
                    </div>
                </div>

                <!-- 圖示類型 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('icon-type') }}</mat-label>
                        <input matInput [formControlName]="'icon_type'" [placeholder]="t('enter-icon-type-optional')">
                    </mat-form-field>
                </div>

                <!-- 顏色 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('color') }}</mat-label>
                        <input matInput [formControlName]="'color'" [placeholder]="t('enter-color-optional')">
                    </mat-form-field>
                </div>

                <!-- 優先級 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('priority') }}</mat-label>
                        <input matInput type="number" [formControlName]="'priority'">
                    </mat-form-field>
                </div>

                <!-- 標籤顯示 -->
                <div class="mt-2 inline-flex w-full items-center justify-between">
                    <mat-checkbox class="-ml-2" [formControlName]="'label_visible'">
                        {{ t('show-label') }}
                    </mat-checkbox>
                </div>

                <!-- 啟用狀態 -->
                <div class="mt-2 inline-flex w-full items-center justify-between">
                    <mat-checkbox class="-ml-2" [formControlName]="'is_active'">
                        {{ t('active') }}
                    </mat-checkbox>
                </div>

                <!-- 備註 -->
                <div class="mt-2">
                    <mat-form-field class="w-full gts-mat-dense">
                        <mat-label>{{ t('notes') }}</mat-label>
                        <textarea matInput [formControlName]="'notes'" rows="3" [placeholder]="t('enter-notes-optional')"></textarea>
                    </mat-form-field>
                </div>

                <!-- Edit Actions -->
                <div class="flex items-center justify-between mt-4 mb-2">
                    @if(isLoading) {
                    <mat-progress-spinner class="mx-auto" [diameter]="24" [mode]="'indeterminate'"></mat-progress-spinner>
                    }
                    @else {
                    <!-- Delete -->
                    <div class="flex items-center space-x-2">
                        @if(page?.record?.id) {
                        <button [color]="'warn'" mat-flat-button (click)="onDelete()">
                            <mat-icon class="pr-2" [svgIcon]="'heroicons_outline:trash'"></mat-icon>{{ t('delete') }}
                        </button>
                        }
                    </div>

                    <!-- Save -->
                    <div>
                        <button mat-flat-button [color]="'primary'" class="mr-2" (click)="onSave()">
                            <mat-icon class="pr-2" [svgIcon]="'heroicons_outline:bookmark-square'"></mat-icon>{{ t('save') }}
                        </button>
                    </div>
                    }
                </div>

            </form>

        </div>
    </div>
</ng-template>
