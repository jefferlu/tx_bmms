<div class="absolute inset-0 flex min-w-0 flex-col h-full overflow-hidden" *transloco="let t">

    <div #firstConditionGroup class="flex w-full border-b">
        <p-tabs class="w-full" [value]="activeTab" (valueChange)="onTabChange($event)">
            <p-tablist>
                <p-tab [value]="'basic'">{{ t('basic-search') }}</p-tab>
                <p-tab [value]="'advanced'">{{ t('advanced-search') }}</p-tab>
            </p-tablist>
            <p-tabpanels>
                <!-- 基本查詢 -->
                <p-tabpanel [value]="'basic'">
                    <div class="flex w-full flex-col sm:flex-row gap-4">
                        <!-- 區域 -->
                        <p-select class="md:w-80 w-full" [options]="regions" [(ngModel)]="selectedRegion" optionLabel="label" [checkmark]="true"
                            [showClear]="true" placeholder="選擇區域" (onChange)="onChangeRegion()" (onClear)="onClear()" />

                        <p-select class="md:w-80 w-full" [options]="selectedRegion?.children" [(ngModel)]="selectedRole" optionLabel="label" [checkmark]="true"
                            [showClear]="true" placeholder="選擇空間/系統" emptyMessage="無資料" (onChange)="onChangeRole()" (onClear)="onClear()" />

                        <p-select class="md:w-80 w-full" [options]="selectedRole?.children" [(ngModel)]="selectedLevel" optionLabel="label" [checkmark]="true"
                            [showClear]="true" placeholder="選擇樓層" emptyMessage="無資料" (onClear)="onClear()" />

                        <!-- <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [showClear]="true" [(ngModel)]="selectedRegions"
                        [options]="regions" placeholder="區域" (onNodeSelect)="onNodeSelect()" (onNodeUnselect)="onNodeSelect()"
                        (onClear)="onClear('region')">
                    </p-treeselect> -->

                        <!-- 空間 -->
                        <!-- <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [showClear]="true" [(ngModel)]="selectedSpaces"
                        [options]="spaces" placeholder="空間" (onNodeSelect)="onNodeSelect()" (onNodeUnselect)="onNodeSelect()"
                        (onClear)="onClear('space')">
                        <ng-template pTemplate="option" let-node>
                            <div (click)="node.children && node.children.length > 0 ? $event.stopPropagation() : null">
                                {{ node.label }}
                            </div>
                        </ng-template>
                    </p-treeselect> -->

                        <!-- 系統 -->
                        <!-- <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [showClear]="true" [(ngModel)]="selectedSystems"
                        [options]="systems" placeholder="系統" (onNodeSelect)="onNodeSelect()" (onNodeUnselect)="onNodeSelect()"
                        (onClear)="onClear('system')">
                        <ng-template pTemplate="option" let-node>
                            <div (click)="node.children && node.children.length > 0 ? $event.stopPropagation() : null">
                                {{ node.label }}
                            </div>
                        </ng-template>
                    </p-treeselect> -->

                        <!-- 關鍵字查詢 -->
                        <p-autocomplete inputStyleClass="sm:min-w-80" [suggestions]="keywordItems" [(ngModel)]="keyword"
                            (completeMethod)="keywordSearch($event)" placeholder="請輸入關鍵字..." emptyMessage="無資料">

                            <!-- 自訂下拉選單中的選項內容 -->
                            <ng-template #item let-item>
                                <div class="flex items-center gap-2">
                                    <!-- <div>{{ item.label }}</div> -->
                                    <!-- <div class="text-sm text-slate-500">{{ item.display_name }}</div> -->
                                    <!-- <div class="">
                                        {{ this.cobieMap[item.display_name] || "未定義" }}
                                        <span class="text-sm text-slate-500 font-medium italic"> {{item.display_name}}</span>
                                    </div> -->
                                    <div class="flex flex-col">
                                        <span class="font-medium">{{ item.label }}</span>
                                        <span class="text-sm text-gray-400">{{ this.cobieMap[item.display_name] || "未定義" }} {{ item.display_name }}</span>
                                    </div>
                                </div>
                            </ng-template>
                        </p-autocomplete>
                        <!-- <input type="text" class="p-2 border rounded-md sm:min-w-64 focus:border-white bg-gray-800 border-gray-700 placeholder:text-gray-400 text-white"
                        placeholder="請輸入關鍵字..." [(ngModel)]="keyword" /> -->

                        <!-- Search -->
                        <div class="ml-auto">
                            <button mat-flat-button (click)="onSearch()">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                                <span class="ml-2">{{t('search')}}</span>
                            </button>
                        </div>
                        <div>
                            <button mat-flat-button [matMenuTriggerFor]="manageCriteria">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:cog-6-tooth'"></mat-icon>
                                <span class="ml-2">{{t('manage-criteria')}}</span>
                            </button>
                            <mat-menu #manageCriteria="matMenu">
                                <button mat-menu-item (click)="onSaveCriteria()">
                                    <span class="flex items-center">
                                        <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:bookmark-square'"></mat-icon>
                                        <span>{{t('save-criteria')}}</span>
                                    </span>
                                </button>
                                <button mat-menu-item (click)="onReadCriteria()">
                                    <span class="flex items-center">
                                        <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                                        <span>{{t('read-criteria')}}</span>
                                    </span>
                                </button>
                                <button mat-menu-item (click)="onClearCriteria()">
                                    <span class="flex items-center">
                                        <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                        <span>{{t('clear-criteria')}}</span>
                                    </span>
                                </button>
                            </mat-menu>
                        </div>
                    </div>
                </p-tabpanel>

                <!-- 進階查詢 -->
                <p-tabpanel [value]="'advanced'">
                    <div class="flex w-full flex-col sm:flex-row gap-4 sm:items-center items-start">
                        <!-- 已選條件顯示區域 -->
                        <div class="flex-1 min-w-0 relative group">
                            <!-- 預設顯示 (與按鈕同高) -->
                            <gts-alert
                                class="cursor-pointer condition-alert"
                                [appearance]="'outline'"
                                [showIcon]="false"
                                [type]="conditions.length > 0 ? 'info' : 'basic'"
                                (click)="toggleOverlay()"
                            >
                                @if(conditions.length > 0){
                                <div class="flex flex-wrap gap-2 max-h-[24px] items-center overflow-hidden">
                                    @for (condition of conditions; track $index) {
                                    <div class="flex items-center gap-1 bg-blue-900/30 px-3 py-1 rounded-md whitespace-nowrap">
                                        <span class="text-sm font-medium">{{ $index + 1 }}.</span>
                                        <span class="text-sm">{{ getConditionDescription(condition) }}</span>
                                    </div>
                                    @if ($index < conditions.length - 1) {
                                    <span class="text-xs text-gray-400 flex items-center">{{ t('and') }}</span>
                                    }
                                    }
                                </div>
                                } @else {
                                <div class="text-center text-gray-400 py-1">{{ t('no-filter-conditions') }}</div>
                                }
                            </gts-alert>

                            <!-- Hover 時顯示的完整內容 (overlay) -->
                            @if(conditions.length > 0){
                            <div class="absolute top-0 left-0 right-0 opacity-0 invisible pointer-events-none group-hover:opacity-100 group-hover:visible group-hover:pointer-events-auto transition-opacity duration-200 z-50">
                                <gts-alert
                                    class="cursor-pointer condition-alert shadow-2xl"
                                    [appearance]="'outline'"
                                    [showIcon]="false"
                                    [type]="'info'"
                                    (click)="toggleOverlay()"
                                >
                                    <div class="flex flex-wrap gap-2 max-h-96 overflow-y-auto">
                                        @for (condition of conditions; track $index) {
                                        <div class="flex items-center gap-1 bg-blue-900/30 px-3 py-1 rounded-md whitespace-nowrap">
                                            <span class="text-sm font-medium">{{ $index + 1 }}.</span>
                                            <span class="text-sm">{{ getConditionDescription(condition) }}</span>
                                        </div>
                                        @if ($index < conditions.length - 1) {
                                        <span class="text-xs text-gray-400 flex items-center">{{ t('and') }}</span>
                                        }
                                        }
                                    </div>
                                </gts-alert>
                            </div>
                            }
                        </div>

                        <!-- 操作按鈕區 -->
                        <div class="flex gap-2 flex-wrap flex-shrink-0">
                            <button mat-flat-button (click)="onSearch()" [disabled]="conditions.length === 0">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                                <span class="ml-2">{{ t('search') }}</span>
                            </button>
                            <button mat-flat-button [matMenuTriggerFor]="manageCriteria">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:cog-6-tooth'"></mat-icon>
                                <span class="ml-2">{{ t('manage-criteria') }}</span>
                            </button>
                            <mat-menu #manageCriteria="matMenu">
                                <button mat-menu-item (click)="onSaveCriteria()">
                                    <span class="flex items-center">
                                        <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:bookmark-square'"></mat-icon>
                                        <span>{{ t('save-criteria') }}</span>
                                    </span>
                                </button>
                                <button mat-menu-item (click)="onReadCriteria()">
                                    <span class="flex items-center">
                                        <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                                        <span>{{ t('read-criteria') }}</span>
                                    </span>
                                </button>
                            </mat-menu>
                        </div>
                    </div>
                </p-tabpanel>

            </p-tabpanels>
        </p-tabs>
    </div>

    <div class="mx-auto flex w-full h-full flex-wrap p-2 overflow-y-auto">
        <div class="flex w-full flex-col md:flex-row gap-2 max-w-full h-full">

            <div class="flex-[1] min-w-0 rounded-md flex flex-col gap-2 md:flex-[1]">

                <div class="flex-[5] bg-card rounded-md sm:flex-[5] md:flex-[5] overflow-y-hidden">
                    <p-table #dataTable class="w-full" [value]="this.objects?.results" [totalRecords]="this.objects?.count" [scrollable]="true"
                        scrollHeight="flex" selectionMode="multiple" [pageLinks]="1" dataKey="id" [styleClass]="'p-datatable-lg'" [rows]="rowsPerPage"
                        [first]="0" [paginator]="true" [lazy]="true" [lazyLoadOnInit]="false" [loading]="isLoading" [selection]="selectedObjects"
                        (onLazyLoad)="onPageChange($event)" (onRowSelect)="onRowSelect($event)" (onRowUnselect)="onRowUnselect($event)">
                        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                            <tr class="hover:bg-hover" [pSelectableRow]="item" [pSelectableRowIndex]="rowIndex">
                                <td class="">
                                    <!-- <p-tableCheckbox [value]="item" /> -->
                                    <button mat-icon-button matSuffix (click)="onFitToObject(item)">
                                        <mat-icon [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                                    </button>
                                </td>
                                <td>{{ item.value }}<br />
                                    <span class="text-sm text-slate-400">Display: {{item.display_name}} ({{item.dbid}})</span><br />
                                    <span class="text-sm text-slate-400">BIM: {{item.name}}</span>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="9" class="text-center border-0">
                                    <div class="flex flex-auto flex-col items-center justify-center h-100">
                                        <mat-icon class="icon-size-12" [svgIcon]="'heroicons_outline:ellipsis-horizontal-circle'"></mat-icon>
                                        <div class="text-secondary mt-4 font-semibold tracking-tight">
                                            {{t('no-data')}}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>

                </div>

                <div class="flex flex-col flex-[2] bg-card rounded-md sm:flex-[2] md:flex-[2] overflow-y-auto pb-4">

                    @if(this.objects?.results.length){
                    <div class="flex flex-col bg-slate-700">
                        <div class="flex items-center justify-between px-4 py-2">
                            <div class="flex items-center justify-start">
                                <div class="text-xl font-semibold leading-tight">查詢結果共 <span class="italic"> {{this.objects?.count}}</span> 筆資料</div>
                            </div>

                            <div class="-mr-3">
                                <button mat-icon-button [matMenuTriggerFor]="exportMenu">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_mini:arrow-down-tray'"></mat-icon>
                                </button>
                                <mat-menu #exportMenu="matMenu">
                                    <button mat-menu-item (click)="onDownloadCsv()">
                                        <span class="flex items-center">
                                            <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:file-csv'"></mat-icon>
                                            <span>匯出 CSV 檔案</span>
                                        </span>
                                    </button>
                                    <button mat-menu-item (click)="onDownloadTxt()">
                                        <span class="flex items-center">
                                            <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_solid:document-text'"></mat-icon>
                                            <span>匯出 TXT 檔</span>
                                        </span>
                                    </button>
                                </mat-menu>
                            </div>
                        </div>

                    </div>

                    <div class="flex flex-col flex-1 overflow-y-auto">
                        <!-- region -->
                        @if(criteriaRegion){
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>區域: {{ criteriaRegion }}</div>
                        </div>
                        }

                        @if(criteriaRole){
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>空間/系統: {{ criteriaRole }}</div>
                        </div>
                        }

                        @if(criteriaLevel){
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>樓層: {{ criteriaLevel }}</div>
                        </div>
                        }

                        <!-- keyword -->
                        @if(this.criteriaKeyword){
                        <div class="flex mt-2 px-4">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>關鍵字：{{ criteriaKeyword.label }} <span class="text-sm text-slate-500 font-medium italic"> {{criteriaKeyword.display_name}}</span></div>
                        </div>
                        }

                        <!-- regions -->
                        <!-- @if (criteriaRegions && criteriaRegions.length > 0) {
                        @for (item of criteriaRegions; track item.name; let index = $index) {
                        @if(index==0){
                        <div class="flex mt-5 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }
                        @else {
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <div class="pl-7">{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }}} -->

                        <!-- spaces -->
                        <!-- @if (criteriaSpaces && criteriaSpaces.length > 0) {
                        @for (item of criteriaSpaces; track item.name; let index = $index) {
                        @if(index==0){
                        <div class="flex mt-5 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }
                        @else {
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <div class="pl-7">{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }}} -->

                        <!-- systems -->
                        <!-- @if (criteriaSystems && criteriaSystems.length > 0) {
                        @for (item of criteriaSystems; track item.name; let index = $index) {
                        @if(index==0){
                        <div class="flex mt-5 px-4" [attr.data-index]="index">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }
                        @else {
                        <div class="flex mt-2 px-4" [attr.data-index]="index">
                            <div class="pl-7">{{ item.name }}: {{ item.criteria }}</div>
                        </div>
                        }}} -->


                    </div>
                    }
                    @else {
                    <ng-container
                        *ngTemplateOutlet="noDataTemplate context: { icon: 'heroicons_outline:ellipsis-horizontal-circle', message: 'no-data' }"></ng-container>
                    }
                </div>

            </div>

            <div class="flex-[1] min-w-0 bg-card rounded-md md:flex-[4]">
                @if (objects?.results.length > 0){
                <aps-viewer #viewer (nodeProperties)="onProperties($event)"></aps-viewer>
                }
                @else {
                <ng-container *ngTemplateOutlet="noDataTemplate context: { icon: 'heroicons_outline:photo', message: 'no-bim-model'}"></ng-container>
                }
            </div>

            <div class="flex flex-col flex-[1] min-w-0 bg-card rounded-md md:flex-[1]">
                @if(nodeInfo){
                <div class="flex flex-col bg-slate-700">
                    <div class="flex items-center justify-start p-4">
                        <mat-icon class="mr-2 icon-size-5" [svgIcon]="'heroicons_outline:window'"></mat-icon>
                        <div class="text-xl font-semibold leading-tight">{{nodeInfo?.name}}</div>
                    </div>
                </div>

                <div class="flex flex-col p-6 flex-1 overflow-y-auto">
                    @for (item of nodeInfo?.properties; track $index) {
                    <div class="text font-medium leading-6 tracking-tight">
                        {{ this.cobieMap[item.displayName] || "未定義" }} <span class="text-sm text-slate-500 font-medium italic"> {{ item.displayName }}</span>
                    </div>
                    <div class="text-sm text-secondary font-medium"></div>
                    <div class="text-sm text-green-500 font-medium pb-3">
                        {{ item.displayValue }}
                    </div>
                    }
                </div>
                }
                @else {
                <ng-container
                    *ngTemplateOutlet="noDataTemplate context: { icon: 'heroicons_outline:ellipsis-horizontal-circle', message: 'no-data' }"></ng-container>
                }
            </div>

        </div>
    </div>

    <ng-template #noDataTemplate let-icon="icon" let-message="message">
        <div class="flex flex-col items-center justify-center h-full">
            <mat-icon class="icon-size-12" [svgIcon]="icon"></mat-icon>
            <div class="text-secondary mt-4 font-semibold tracking-tight">
                {{t(message)}}
            </div>
        </div>
    </ng-template>
</div>

<!-- Overlay 內容（所有條件組） -->
<ng-template cdkPortal #overlayContent="cdkPortal" *transloco="let t">
    <div class="bg-default p-4 flex flex-col gap-4 w-full overflow-auto">
        @for (condition of conditions; track $index; let i = $index) {
        <div class="flex w-full flex-col sm:flex-row gap-4">
            <p-select class="md:w-80 w-full" [options]="conditionNames" [(ngModel)]="condition.condition1" optionLabel="description" [checkmark]="true"
                [filter]="true" placeholder="選擇COBie" appendTo="body">
                <!-- 自訂選擇後的顯示內容 -->
                <ng-template #selectedItem let-selectedOption>
                    @if(selectedOption){
                    <span class="font-medium">{{ selectedOption.description }}</span>&nbsp;
                    <span class="text-sm text-gray-400">{{ selectedOption.display_name }}</span>
                    }
                </ng-template>

                <!-- 自訂下拉選單中的選項內容 -->
                <ng-template let-option #item>
                    <div class="flex flex-col">
                        <span class="font-medium">{{ option.description }}</span>
                        <span class="text-sm text-gray-400">{{ option.display_name }}</span>
                    </div>
                </ng-template>
            </p-select>

            <p-select class="md:w-40 w-full" [options]="conditionTypes" [(ngModel)]="condition.condition2" optionLabel="label" placeholder="選擇類型"
                appendTo="body" (onChange)="updateOperators(condition)" />

            <p-select class="md:w-40 w-full" [options]="condition.operators" [(ngModel)]="condition.condition3" optionLabel="label" placeholder="選擇運算符"
                appendTo="body" (onChange)="onOperatorChange($event, condition)" />

            @if(condition.condition3?.value==='range'){
            <input type="text" class="p-2 border rounded-md sm:w-[9.5rem] focus:border-white bg-gray-800 border-gray-700 placeholder:text-gray-400 text-white"
                [placeholder]="t('min-value')" [(ngModel)]="condition.min_value" />

            <input type="text" class="p-2 border rounded-md sm:w-[9.5rem] focus:border-white bg-gray-800 border-gray-700 placeholder:text-gray-400 text-white"
                [placeholder]="t('max-value')" [(ngModel)]="condition.max_value" />
            }
            <!-- 單一條件 -->
            @else{
            <input type="text" class="p-2 border rounded-md sm:min-w-80 focus:border-white bg-gray-800 border-gray-700 placeholder:text-gray-400 text-white"
                [placeholder]="t('condition-value')+'...'" [(ngModel)]="condition.condition4" />
            }

            <!-- 移除按鈕 -->
            <button mat-icon-button (click)="removeConditionGroup(i)">
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
            </button>
        </div>
        }
        <div class="flex justify-center gap-2">
            <button mat-flat-button (click)="addConditionGroup()">
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                <span class="ml-2">{{ t('add-condition-group') }}</span>
            </button>
            <!-- 新增：關閉按鈕 -->
            <button mat-flat-button (click)="closeOverlay()">
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                <span class="ml-2">{{ t('close') }}</span>
            </button>
        </div>
    </div>
</ng-template>