<div class="absolute inset-0 flex min-w-0 flex-col h-full overflow-hidden" *transloco="let t">

    <div class="flex w-full p-2 border-b">
        <div class="flex w-full flex-col sm:flex-row gap-4">
            <!-- 區域 -->
            <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [(ngModel)]="selectedRegions" [options]="regions"
                placeholder="區域" (onNodeSelect)="onNodeSelect($event,'region')">
                <ng-template pTemplate="option" let-node>
                    <div (click)="node.children && node.children.length > 0 ? $event.stopPropagation() : null">
                        {{ node.label }}
                    </div>
                </ng-template>
            </p-treeselect>

            <!-- 空間 -->
            <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [(ngModel)]="selectedSpaces" [options]="spaces"
                placeholder="空間" (onNodeSelect)="onNodeSelect($event,'space')">
                <ng-template pTemplate="option" let-node>
                    <div (click)="node.children && node.children.length > 0 ? $event.stopPropagation() : null">
                        {{ node.label }}
                    </div>
                </ng-template>
            </p-treeselect>

            <!-- 系統 -->
            <p-treeselect class="md:w-80 w-full" containerStyleClass="w-full" selectionMode="multiple" [(ngModel)]="selectedSystems" [options]="systems"
                placeholder="系統" (onNodeSelect)="onNodeSelect($event,'system')">
                <ng-template pTemplate="option" let-node>
                    <div (click)="node.children && node.children.length > 0 ? $event.stopPropagation() : null">
                        {{ node.label }}
                    </div>
                </ng-template>
            </p-treeselect>

            <!-- 關鍵字查詢 -->
            <input type="text" class="p-2 border rounded-md sm:min-w-64 focus:border-white bg-gray-800 border-gray-700 placeholder:text-gray-400 text-white"
                placeholder="請輸入關鍵字..." [(ngModel)]="keyword" />

            <!-- Search -->
            <div>
                <button mat-flat-button (click)="onSearch()">
                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                    <span class="ml-2">{{t('search')}}</span>
                </button>
            </div>
        </div>
    </div>

    <div class="mx-auto flex w-full h-full flex-wrap p-2 overflow-y-auto">
        <div class="flex w-full flex-col md:flex-row gap-2 max-w-full h-full">
            <div class="flex-[1] min-w-0 bg-card rounded-md md:flex-[1] h-full">
                <!-- 區塊 1 (1/6) -->
                <p-table #dataTable class="w-full" [value]="data?.results" [totalRecords]="data?.count" [scrollable]="true" scrollHeight="flex"
                    selectionMode="multiple" [pageLinks]="1" dataKey="id" [styleClass]="'p-datatable-lg'" [rows]="rowsPerPage" [paginator]="true" [lazy]="true"
                    [lazyLoadOnInit]="false" [loading]="isLoading" [selection]="selectedObjects" (onLazyLoad)="onPageChange($event)"
                    (onRowSelect)="onRowSelect($event)" (onRowUnselect)="onRowUnselect($event)">
                    <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                        <tr class="hover:bg-hover" [pSelectableRow]="item" [pSelectableRowIndex]="rowIndex">
                            <td class="pl-8">
                                <p-tableCheckbox [value]="item" />
                            </td>
                            <td>{{ item.value }} ({{ item.dbid }})</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="9" class="text-center border-0">
                                <div class="flex flex-auto flex-col items-center justify-center h-128">
                                    <mat-icon class="icon-size-12" [svgIcon]="'heroicons_outline:ellipsis-horizontal-circle'"></mat-icon>
                                    <div class="text-secondary mt-4 font-semibold tracking-tight">
                                        {{t('no-data')}}
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
            <div class="flex-[1] min-w-0 rounded-md flex flex-col gap-2 md:flex-[2]">
                <div class="flex-[1] bg-card rounded-md sm:flex-[1] md:flex-[1] overflow-y-auto pb-4">

                    @if(this.data?.results.length){
                    <div class="flex flex-col bg-slate-700">
                        <div class="flex items-center justify-between px-4 py-2">
                            <div class="flex items-center justify-start">
                               
                                <div class="text-xl font-semibold leading-tight">查詢結果：全部 {{data?.count}} 筆資料</div>
                            </div>

                            <div class="-mr-3">
                                <button mat-icon-button [matMenuTriggerFor]="exportMenu">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_mini:arrow-down-tray'"></mat-icon>
                                </button>
                                <mat-menu #exportMenu="matMenu">
                                    <button mat-menu-item>
                                        <span class="flex items-center">
                                            <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_outline:file-csv'"></mat-icon>
                                            <span>匯出 CSV 檔案</span>
                                        </span>
                                    </button>
                                    <button mat-menu-item>
                                        <span class="flex items-center">
                                            <mat-icon class="mr-3 icon-size-5" [svgIcon]="'heroicons_solid:document-text'"></mat-icon>
                                            <span>匯出 TXT 檔</span>
                                        </span>
                                    </button>
                                </mat-menu>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <!-- <div class="flex items-center justify-between">
                            <div class="text-lg font-semibold leading-tight">查詢條件：</div>
                        </div> -->
                        <!-- <div class="flex items-center justify-start px-4 py-4">
                            <div class="text-lg font-semibold leading-tight">查詢條件</div>
                        </div> -->
                        @if(this.criteriaRegions){
                        <div class="flex mt-5 px-4">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ criteriaRegions }}</div>
                        </div>
                        }
                        @if(this.criteriaSpaces){
                        <div class="flex mt-5 px-4">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ criteriaSpaces }}</div>
                        </div>
                        }
                        @if(this.criteriaSystems){
                        <div class="flex mt-5 px-4">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ criteriaSystems }}</div>
                        </div>
                        }
                        @if(this.criteriaKeyword){
                        <div class="flex mt-5 px-4">
                            <mat-icon class="mr-2 mt-0.5 icon-size-5 text-secondary" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <div>{{ criteriaKeyword }}</div>
                        </div>
                        }
                    </div>
                    }
                    @else {
                    <ng-container
                        *ngTemplateOutlet="noDataTemplate context: { icon: 'heroicons_outline:ellipsis-horizontal-circle', message: 'no-data' }"></ng-container>
                    }
                </div>
                <div class="flex-[2] bg-card rounded-md sm:flex-[2] md:flex-[2] overflow-y-hidden">
                    @if(nodeInfo){
                    <div class="flex flex-col bg-slate-700">
                        <div class="flex items-center justify-start p-4">
                            <mat-icon class="mr-2 icon-size-5" [svgIcon]="'heroicons_outline:identification'"></mat-icon>
                            <div class="text-xl font-semibold leading-tight">{{nodeInfo?.name}}</div>
                        </div>
                    </div>
                    }

                    <p-table #propertyTable class="w-full" [value]="nodeInfo?.properties" [scrollable]="true" scrollHeight="flex"
                        [styleClass]="'p-datatable-lg'">
                        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
                            <tr class="hover:bg-hover">
                                <td>{{ item.displayName }}</td>
                                <td>{{ item.displayValue }}</td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="9" class="text-center border-0">
                                    <div class="flex flex-auto flex-col items-center justify-center h-100">
                                        <mat-icon class="icon-size-12" [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                                        <div class="text-secondary mt-4 font-semibold tracking-tight">
                                            {{t('no-data')}}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>

                </div>
            </div>
            <div class="flex-[1] min-w-0 bg-card rounded-md md:flex-[3]">
                @if (selectedObjects?.length > 0){
                <aps-viewer [data]="selectedObjects" (nodeProperties)="onProperties($event)"></aps-viewer>
                }
                @else {
                <ng-container *ngTemplateOutlet="noDataTemplate context: { icon: 'heroicons_outline:photo', message: 'no-bim-model'}"></ng-container>
                }
            </div>
        </div>
    </div>

    <ng-template #noDataTemplate let-icon="icon" let-message="message">
        <div class="flex flex-col items-center justify-center h-full">
            <mat-icon class="icon-size-12" [svgIcon]="icon"></mat-icon>
            <div class="text-secondary mt-4 font-semibold tracking-tight">
                {{t(message)}}
            </div>
        </div>
    </ng-template>
</div>