services:
    client:
        build: client
        container_name: bmms_client
        restart: always
        networks:
            - internal_network
        environment:
            - NODE_ENV=production
            - TZ=Asia/Taipei
        volumes:
            - static_data:/app/static-root
            - media_data:/app/media-root
            - media_files:/app/media-files
        ports:
            - "4000:80"

    backend:
        build: backend
        container_name: bmms_backend
        restart: always
        entrypoint: ./entrypoint.sh
        networks:
            - internal_network
        environment:
            - DEBUG=FALSE
            - CSRF_TRUSTED_ORIGINS=https://bmms.gtsoftec.com
            - POSTGRESQL_USERNAME=bmms
            - POSTGRESQL_PASSWORD=qbZucM8vvGwpfTd
            - POSTGRESQL_DATABASE=bmms
            - HOST=postgres
            - PORT=5432
            - TZ=Asia/Taipei
            # MQTT Settings
            - MQTT_BROKER_HOST=vernemq
            - MQTT_BROKER_PORT=1883
            - MQTT_BROKER_WS_PORT=8083
            - MQTT_BROKER_USERNAME=
            - MQTT_BROKER_PASSWORD=
            - MQTT_KEEPALIVE=60
            - MQTT_CLIENT_ID_PREFIX=tx_bmms
            # Redis Settings
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_DB=0
            - REDIS_PASSWORD=
            # Sensor Data Settings
            - SENSOR_DATA_SAVE_TO_DB=False
            - SENSOR_DATA_RETENTION_HOURS=168
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - static_data:/app/static-root
            - media_data:/app/media-root
            - ./backend/media-root/backups:/app/media-root/backups
        depends_on:
            - postgres
            - redis
            - vernemq
        ports:
            - "8100:80"

    celery:
        build: backend
        container_name: bmms_celery
        restart: always
        command: celery -A tx_bmms worker --loglevel=info --events
        networks:
            - internal_network
        environment:
            - DEBUG=FALSE
            - POSTGRESQL_USERNAME=bmms
            - POSTGRESQL_PASSWORD=qbZucM8vvGwpfTd
            - POSTGRESQL_DATABASE=bmms
            - HOST=postgres
            - PORT=5432
            - TZ=Asia/Taipei
            # MQTT Settings
            - MQTT_BROKER_HOST=vernemq
            - MQTT_BROKER_PORT=1883
            # Redis Settings
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - REDIS_DB=0
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - static_data:/app/static-root
            - media_data:/app/media-root
            - ./backend/media-root/backups:/app/media-root/backups
        depends_on:
            - redis
            - postgres
            - vernemq

    redis:
        image: redis:7-alpine
        container_name: bmms_redis
        restart: always
        command: redis-server --appendonly yes
        networks:
            - internal_network
        environment:
            - TZ=Asia/Taipei
        volumes:
            - redis_data:/data
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 3

    postgres:
        image: bitnami/postgresql:latest
        container_name: bmms_postgres
        restart: always
        networks:
            - internal_network
        environment:
            - POSTGRESQL_USERNAME=bmms
            - POSTGRESQL_PASSWORD=qbZucM8vvGwpfTd
            - POSTGRESQL_DATABASE=bmms
            - TZ=Asia/Taipei
        volumes:
            - ./db:/docker-entrypoint-initdb.d
            - postgresql_data:/bitnami/postgresql
            - ./backend/media-root/backups:/backups
        ports:
            - 5439:5432

    elfinder:
        build: elfinder
        container_name: bmms_elfinder
        restart: always
        networks:
            - internal_network
        environment:
            - TZ=Asia/Taipei
            - DJANGO_SECRET_KEY=django-insecure-=qxo)i^(3nhpn@=dfdfw^$du=jiayia=955h4gjnqj59do=#bu
            - CORS_ALLOWED_ORIGINS=https://bmms.gtsoftec.com
        volumes:
            - media_files:/app/media-files

    vernemq:
        image: vernemq/vernemq:latest
        container_name: bmms_vernemq
        restart: always
        hostname: vernemq
        networks:
            - internal_network
        environment:
            # 接受 EULA
            - DOCKER_VERNEMQ_ACCEPT_EULA=yes
            # 允許匿名連線 (開發環境: on, 生產環境應改為: off)
            - DOCKER_VERNEMQ_ALLOW_ANONYMOUS=on
            # MQTT TCP Listener (標準 MQTT 協議)
            - DOCKER_VERNEMQ_LISTENER__TCP__DEFAULT=0.0.0.0:1883
            # MQTT WebSocket Listener (瀏覽器使用)
            - DOCKER_VERNEMQ_LISTENER__WS__DEFAULT=0.0.0.0:8083
            # Log 設定
            - DOCKER_VERNEMQ_LOG__CONSOLE__LEVEL=info
            - DOCKER_VERNEMQ_LOG__CONSOLE__FILE=/vernemq/log/vernemq.log
            # 效能設定
            - DOCKER_VERNEMQ_MAX_CLIENT_ID_SIZE=100
            - DOCKER_VERNEMQ_MAX_OFFLINE_MESSAGES=1000
            - DOCKER_VERNEMQ_MAX_ONLINE_MESSAGES=1000
            # 持久化設定
            - DOCKER_VERNEMQ_PERSISTENCE=on
            - DOCKER_VERNEMQ_PERSISTENCE_DIR=/vernemq/data
            - TZ=Asia/Taipei
        ports:
            - "1883:1883"  # MQTT TCP
            - "8083:8083"  # MQTT WebSocket
        volumes:
            - vernemq_log:/vernemq/log
            - vernemq_data:/vernemq/data
        healthcheck:
            test: ["CMD", "vernemq", "ping"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    flower:
        build: backend
        container_name: bmms_flower
        restart: always
        networks:
            - internal_network
        command: >
            celery -A tx_bmms flower --port=5555 --broker=redis://bmms_redis:6379/0 --persistent=True --db=/app/flower.db
        environment:
            - DEBUG=FALSE
            - TZ=Asia/Taipei
        depends_on:
            - redis
            - celery
        ports:
            - "5555:5555"
        volumes:
            - flower_data:/app

volumes:
    static_data:
    media_data:
    media_files:
    postgresql_data:
    flower_data:
    redis_data:
    vernemq_data:
    vernemq_log:

networks:
    internal_network:
        driver: bridge
